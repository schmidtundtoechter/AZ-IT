[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-29 09:05:02.851962",
  "module": "Az It",
  "name": "Customer Internal Number Auto Assignment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "# Server Script for Customer - Auto Generate Internal Customer Number\n# Event: Before Insert\n\n# Only proceed if the internal customer number field is empty\nif not doc.custom_interne_kundennummer:\n    # Get the highest existing customer number >= 20000\n    highest_customer = frappe.db.sql(\"\"\"\n        SELECT custom_interne_kundennummer \n        FROM `tabCustomer` \n        WHERE custom_interne_kundennummer IS NOT NULL \n        AND custom_interne_kundennummer != '' \n        AND CAST(custom_interne_kundennummer AS UNSIGNED) >= 20000\n        ORDER BY CAST(custom_interne_kundennummer AS UNSIGNED) DESC \n        LIMIT 1\n    \"\"\", as_dict=True)\n    \n    # Default starting number\n    next_number = 20000\n    \n    # If we found a highest number, increment it\n    if highest_customer and highest_customer[0].custom_interne_kundennummer:\n        try:\n            current_number = int(highest_customer[0].custom_interne_kundennummer)\n            if current_number >= 20000:\n                next_number = current_number + 1\n        except ValueError:\n            # If conversion fails, use default 20000\n            next_number = 20000\n    \n    # Set the new customer number (exactly 5 characters, padded with zeros)\n    doc.custom_interne_kundennummer = str(next_number).zfill(5)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-29 09:07:22.693443",
  "module": "Az It",
  "name": "Customer Internal Number Auto Assignment - Update",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "# Server Script for Customer - Auto Generate Internal Customer Number on Update\n# Event: Before Save\n\n# Only proceed if the internal customer number field is empty\nif not doc.custom_interne_kundennummer:\n    # Get the highest existing customer number >= 20000\n    highest_customer = frappe.db.sql(\"\"\"\n        SELECT custom_interne_kundennummer \n        FROM `tabCustomer` \n        WHERE custom_interne_kundennummer IS NOT NULL \n        AND custom_interne_kundennummer != '' \n        AND CAST(custom_interne_kundennummer AS UNSIGNED) >= 20000\n        ORDER BY CAST(custom_interne_kundennummer AS UNSIGNED) DESC \n        LIMIT 1\n    \"\"\", as_dict=True)\n    \n    # Default starting number\n    next_number = 20000\n    \n    # If we found a highest number, increment it\n    if highest_customer and highest_customer[0].custom_interne_kundennummer:\n        try:\n            current_number = int(highest_customer[0].custom_interne_kundennummer)\n            if current_number >= 20000:\n                next_number = current_number + 1\n        except ValueError:\n            # If conversion fails, use default 20000\n            next_number = 20000\n    \n    # Set the new customer number (exactly 5 characters, padded with zeros)\n    doc.custom_interne_kundennummer = str(next_number).zfill(5)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-05 13:27:24.384288",
  "module": "Az It",
  "name": "Ersteingabe Lead AZ-IT - Erzeuge Lead, Adresse und Kontakt v2",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Ersteingabe Lead AZ-IT",
  "script": "# Server Script for \"Ersteingabe Lead AZ-IT\"\n# Trigger: Before Save\n\n# Step 1: Create the 'kompletter_name' based on 'vornahme', 'zweiter_vornahme', 'nachnahme'\nname_parts = []\n\nif doc.vornahme:\n    name_parts.append(doc.vornahme)\n\nif doc.zweiter_vornahme:\n    name_parts.append(doc.zweiter_vornahme)\n\nif doc.nachnahme:\n    name_parts.append(doc.nachnahme)\n\n# Zusammensetzen der Namensteile mit Leerzeichen\ndoc.kompletter_name = \" \".join(name_parts)\n\n# Step 2: Create new Lead entry\nnew_lead = frappe.get_doc({\n    \"doctype\": \"Lead\",\n    \"status\": \"Lead\",\n    \"custom_status_intern\": \"Lead\",\n    \"company_name\": doc.hfz,\n    \"custom_thema\": doc.thema,\n    \"custom_leadquelle\": doc.leadquelle,\n    \"job_title\": doc.position,\n    \"salutation\": doc.anrede,\n    \"first_name\": doc.vornahme,\n    \"middle_name\": doc.zweiter_vornahme,\n    \"last_name\": doc.nachnahme,\n    \"lead_name\": doc.kompletter_name,\n    \"gender\": doc.geschlecht,\n    \"custom_adresse_mutterunternehmen\": doc.adresse_mutterunternehmen,\n    \"custom_kontakt_mutterunternehmen\": doc.kontakt_mutterunternehmen,\n    \"no_of_employees\": doc.select_lapl,\n    \"industry\": doc.wirtschaftsbranche,\n    \"custom_straße\": doc.adresse_zeile_1,\n    \"custom_hausnummer\": doc.adresse_zeile_2,\n    \"custom_ort\": doc.ort_wohnort,\n    \"custom_plz\": doc.plz,\n    \"custom_land\": doc.land,\n    \"address_html\": doc.webseite,\n    \"campaign_name\": doc.kampagnenname,\n    \"language\": doc.drucksprache,\n    \"disabled\": doc.deaktiviert,\n    \"unsubscribed\": doc.unsubscribed,\n    \"blog_subscriber\": doc.blog_subscriber,\n    \"company\": \"AZ IT-Systems & Consulting GmbH\",\n    # MODIFIED: Store company contact info in Lead fields instead of Contact\n    \"custom_telefon_zentrale\": doc.telefon_zentrale,\n    \"custom_email_zentrale\": doc.email,\n    \"email_id\": doc.email_ansprechpartner,  # Personal contact email\n    \"website\": doc.webseite\n})\n\n# Speichern des Leads\nnew_lead.insert(ignore_permissions=True)\n\n# Step 3: Remove automatically generated Contact (if any)\nauto_contact = frappe.get_all(\"Contact\", filters={\"link_doctype\": \"Lead\", \"link_name\": new_lead.name})\nif auto_contact:\n    for contact in auto_contact:\n        frappe.delete_doc(\"Contact\", contact.name, ignore_permissions=True)\n\n# Step 4: Create new Contact entry\nnew_contact = frappe.get_doc({\n    \"doctype\": \"Contact\",\n    \"custom_präfix\": doc.titel,\n    \"first_name\": doc.vornahme,\n    \"middle_name\": doc.zweiter_vornahme,\n    \"last_name\": doc.nachnahme,\n    \"salutation\": doc.anrede,\n    \"designation\": doc.position,\n    \"gender\": doc.geschlecht,\n    \"company_name\": doc.hfz,\n    \"status\": \"Passive\",\n    \"is_primary_contact\": doc.ist_hauptkontakt,\n    \"is_billing_contact\": doc.ist_primärer_rechnungskontakt,\n    \"department\": doc.abteilung\n})\n\n# Speichern des Kontakts\nnew_contact.insert(ignore_permissions=True)\n\n# Step 5: Add phone numbers (MODIFIED: Only personal phone, not company phone)\nif doc.telefon:\n    new_contact.append(\"phone_nos\", {\n        \"phone\": doc.telefon,\n        \"is_primary_phone\": 1\n    })\n\n# REMOVED: Company phone (telefon_zentrale) is now stored in Lead field\n# if doc.telefon_zentrale:\n#     new_contact.append(\"phone_nos\", {\n#         \"phone\": doc.telefon_zentrale\n#     })\n\n# Speichern des Kontakts nach dem Hinzufügen der Telefonnummern\nnew_contact.save(ignore_permissions=True)\n\n# Step 6: Add email addresses (MODIFIED: Only personal email, not company email)\nif doc.email_ansprechpartner:\n    new_contact.append(\"email_ids\", {\n        \"email_id\": doc.email_ansprechpartner,\n        \"is_primary\": 1\n    })\n\n# REMOVED: Company email (doc.email) is now stored in Lead field\n# if doc.email:\n#     new_contact.append(\"email_ids\", {\n#         \"email_id\": doc.email\n#     })\n\n# Speichern des Kontakts nach dem Hinzufügen der E-Mail-Adressen\nnew_contact.save(ignore_permissions=True)\n\n# Step 7: Create new Address entry\nnew_address = frappe.get_doc({\n    \"doctype\": \"Address\",\n    \"address_title\": doc.kompletter_name,\n    \"address_type\": \"Other\",\n    \"address_line1\": doc.adresse_zeile_1,\n    \"address_line2\": doc.adresse_zeile_2,\n    \"city\": doc.ort_wohnort,\n    \"county\": doc.land,\n    \"pincode\": doc.plz,\n    \"email_id\": doc.email_ansprechpartner,  # Use personal email for address\n    \"phone\": doc.telefon,  # Use personal phone for address\n    \"is_primary_address\": doc.ist_hauptkontakt,\n    \"is_shipping_address\": doc.ist_versandanschrift\n})\n\n# Link Address to Lead\nnew_address.append(\"links\", {\n    \"link_doctype\": \"Lead\",\n    \"link_name\": new_lead.name\n})\n\n# Speichern der Adresse\nnew_address.insert(ignore_permissions=True)\n\n# Step 8: Update Lead with Contact ID\nnew_lead.custom_aktueller_primärkontakt = new_contact.name\nnew_lead.save(ignore_permissions=True)\n\n# Step 9: Add the link from Contact to Lead\nnew_contact.append(\"links\", {\n    \"link_doctype\": \"Lead\",\n    \"link_name\": new_lead.name,\n    \"link_title\": new_lead.lead_name\n})\n\n# Speichern des Kontakts nach Hinzufügen des Links\nnew_contact.save(ignore_permissions=True)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": "0 1 * * *",
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Cron",
  "modified": "2025-11-26 10:28:36.387458",
  "module": "Az It",
  "name": "Aufgabe (ToDo) automatische Wiedervorlage erzeugen (V2)",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Modified AutoWV Script for ERPNext Server Script (Cron Job)\n# Goal: Only one current task should be created every 7 days, old AutoWV tasks should be cancelled\n\n# Get all leads that need reminders\nfor doclead in frappe.db.get_all(\n    \"Lead\",\n    filters={\n        \"custom_status_intern\": [\"not in\", [\"Chance\", \"Kunde\", \"Out\"]],\n        \"status\": [\"not in\", [\"Opportunity\", \"Quotation\", \"Lost Quotation\", \"Do Not Contact\"]]\n    }\n):\n\n    # Get company name for this lead\n    compname = frappe.db.get_value(\"Lead\", doclead.name, \"company_name\")\n    if compname:\n        beschreibung = \"AutoWV: \" + compname\n    else:\n        beschreibung = \"AutoWV: n.n.\"\n\n    # Get all existing ToDos for this lead\n    existing_todos = frappe.db.get_all(\n        \"ToDo\",\n        filters={\n            \"reference_name\": doclead.name,\n            \"reference_type\": \"Lead\"\n        },\n        fields=[\"name\", \"description\", \"date\", \"status\"],\n        order_by=\"date desc\"\n    )\n\n    # Separate AutoWV todos from manual todos\n    autowv_todos = []\n    all_future_todos = []\n\n    today_date = frappe.utils.getdate()\n\n    for todo in existing_todos:\n        # Check if this is an AutoWV todo\n        if todo.description and \"AutoWV:\" in todo.description:\n            autowv_todos.append(todo)\n\n        # Check if this is a future open todo (any type)\n        if todo.status == \"Open\" and frappe.utils.getdate(todo.date) >= today_date:\n            all_future_todos.append(todo)\n\n    # Cancel old/past AutoWV todos\n    for autowv_todo in autowv_todos:\n        todo_date = frappe.utils.getdate(autowv_todo.date)\n\n        # Cancel if it's in the past\n        if todo_date < today_date and autowv_todo.status == \"Open\":\n            doc = frappe.get_doc(\"ToDo\", autowv_todo.name)\n            doc.status = \"Cancelled\"\n            doc.save()\n\n    # Get remaining future AutoWV todos after cleanup\n    future_autowv_todos = []\n    for autowv_todo in autowv_todos:\n        todo_date = frappe.utils.getdate(autowv_todo.date)\n        if todo_date >= today_date and autowv_todo.status == \"Open\":\n            future_autowv_todos.append(autowv_todo)\n\n    # If there are multiple future AutoWV todos, keep only the most recent one\n    if len(future_autowv_todos) > 1:\n        # Sort by date descending and keep only the first (most recent)\n        future_autowv_todos.sort(key=lambda x: frappe.utils.getdate(x.date), reverse=True)\n        for todo_to_cancel in future_autowv_todos[1:]:\n            doc = frappe.get_doc(\"ToDo\", todo_to_cancel.name)\n            doc.status = \"Cancelled\"\n            doc.save()\n\n    # Check if we should create a new AutoWV reminder\n    should_create_new = True\n\n    # Don't create if there are any future todos (AutoWV or manual)\n    if all_future_todos:\n        should_create_new = False\n\n    # Don't create if there was an AutoWV todo in the last 6 days\n    if should_create_new:\n        for autowv_todo in autowv_todos:\n            todo_date = frappe.utils.getdate(autowv_todo.date)\n            days_diff = (today_date - todo_date).days\n            if days_diff <= 6 and days_diff >= 0:\n                should_create_new = False\n                break\n\n    # Create new AutoWV reminder if needed\n    if should_create_new:\n        n = frappe.new_doc(\"ToDo\")\n        n.reference_type = \"Lead\"\n        n.reference_name = doclead.name\n        n.status = \"Open\"\n        n.priority = \"Medium\"\n        n.date = frappe.utils.add_to_date(frappe.utils.today(), days=6)\n        n.description = beschreibung\n        n.insert()",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 11:20:54.361736",
  "module": "Az It",
  "name": "Lieferschein - ausliefernder_mitarbieter beim Speichern eintragen",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "doc.custom_delivery_employee = frappe.session.user",
  "script_type": "DocType Event"
 }
]